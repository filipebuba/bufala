name: Moransa CI/CD - Review AutomÃ¡tico

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.10'
  FLUTTER_VERSION: '3.16.0'
  NODE_VERSION: '18'

jobs:
  # Job 1: AnÃ¡lise de Qualidade do Backend
  backend-quality:
    name: ğŸ Backend Quality Check
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ”§ Instalar dependÃªncias
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pylint black flake8 mypy pytest pytest-cov safety bandit

    - name: ğŸ¨ Verificar formataÃ§Ã£o com Black
      run: |
        cd backend
        black --check --diff .

    - name: ğŸ” AnÃ¡lise com Flake8
      run: |
        cd backend
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: ğŸ”¬ AnÃ¡lise com Pylint
      run: |
        cd backend
        pylint $(find . -name "*.py" | head -20) --exit-zero

    - name: ğŸ›¡ï¸ VerificaÃ§Ã£o de seguranÃ§a com Bandit
      run: |
        cd backend
        bandit -r . -f json -o bandit-report.json || true

    - name: ğŸ“Š VerificaÃ§Ã£o de vulnerabilidades com Safety
      run: |
        cd backend
        safety check --json --output safety-report.json || true

    - name: ğŸ§ª Executar testes com cobertura
      run: |
        cd backend
        pytest --cov=. --cov-report=xml --cov-report=html --cov-fail-under=70

    - name: ğŸ“ˆ Upload cobertura para Codecov
      uses: codecov/codecov-action@v3
      with:
        file: backend/coverage.xml
        flags: backend
        name: backend-coverage

  # Job 2: Build e Teste do Android App
  android-build:
    name: ğŸ“± Android Build & Test
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: ğŸ“¦ Cache Flutter dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          android_app/.dart_tool
        key: ${{ runner.os }}-flutter-${{ hashFiles('android_app/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: ğŸ”§ Instalar dependÃªncias Flutter
      run: |
        cd android_app
        flutter pub get

    - name: ğŸ” AnÃ¡lise estÃ¡tica do cÃ³digo Dart
      run: |
        cd android_app
        flutter analyze --fatal-infos

    - name: ğŸ¨ Verificar formataÃ§Ã£o Dart
      run: |
        cd android_app
        dart format --set-exit-if-changed .

    - name: ğŸ§ª Executar testes unitÃ¡rios
      run: |
        cd android_app
        flutter test --coverage

    - name: ğŸ§ª Executar testes de integraÃ§Ã£o
      run: |
        cd android_app
        flutter test integration_test/

    - name: ğŸ—ï¸ Build APK de teste
      run: |
        cd android_app
        flutter build apk --debug

    - name: ğŸ“ˆ Upload cobertura Flutter
      uses: codecov/codecov-action@v3
      with:
        file: android_app/coverage/lcov.info
        flags: flutter
        name: flutter-coverage

    - name: ğŸ“¦ Upload APK como artefato
      uses: actions/upload-artifact@v3
      with:
        name: debug-apk
        path: android_app/build/app/outputs/flutter-apk/app-debug.apk

  # Job 3: VerificaÃ§Ã£o do Frontend
  frontend-check:
    name: ğŸŒ Frontend Quality Check
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Validar HTML
      run: |
        cd frontend
        # Verificar sintaxe HTML bÃ¡sica
        python3 -c "
        import html.parser
        import sys
        
        class HTMLValidator(html.parser.HTMLParser):
            def error(self, message):
                print(f'HTML Error: {message}')
                sys.exit(1)
        
        with open('index.html', 'r', encoding='utf-8') as f:
            content = f.read()
            validator = HTMLValidator()
            validator.feed(content)
        print('âœ… HTML vÃ¡lido')
        "

    - name: ğŸ¨ Verificar CSS
      run: |
        cd frontend
        # Verificar se nÃ£o hÃ¡ CSS inline excessivo
        python3 -c "
        import re
        with open('index.html', 'r', encoding='utf-8') as f:
            content = f.read()
            css_blocks = re.findall(r'<style[^>]*>(.*?)</style>', content, re.DOTALL)
            total_css = sum(len(block) for block in css_blocks)
            if total_css > 50000:
                print(f'âš ï¸ CSS muito extenso: {total_css} caracteres')
            else:
                print(f'âœ… CSS dentro do limite: {total_css} caracteres')
        "

    - name: ğŸ”— Verificar links
      run: |
        cd frontend
        python3 -c "
        import re
        with open('index.html', 'r', encoding='utf-8') as f:
            content = f.read()
            # Verificar links relativos
            relative_links = re.findall(r'href=[\"\']([^\"\'>]+)[\"\']', content)
            for link in relative_links:
                if link.startswith('../'):
                    print(f'âœ… Link relativo encontrado: {link}')
        print('âœ… VerificaÃ§Ã£o de links concluÃ­da')
        "

  # Job 4: VerificaÃ§Ã£o de SeguranÃ§a Geral
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ” Verificar segredos expostos
      run: |
        # Verificar se nÃ£o hÃ¡ chaves API ou senhas expostas
        if grep -r -i "api[_-]key\|password\|secret\|token" --include="*.py" --include="*.dart" --include="*.html" . | grep -v ".git" | grep -v "example" | grep -v "test"; then
          echo "âš ï¸ PossÃ­veis segredos encontrados no cÃ³digo"
          exit 1
        else
          echo "âœ… Nenhum segredo exposto encontrado"
        fi

    - name: ğŸ”’ Verificar permissÃµes Android
      run: |
        cd android_app
        if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
          echo "ğŸ“‹ PermissÃµes Android encontradas:"
          grep -o 'android.permission.[A-Z_]*' android/app/src/main/AndroidManifest.xml | sort | uniq
          echo "âœ… VerificaÃ§Ã£o de permissÃµes concluÃ­da"
        fi

  # Job 5: Build de ProduÃ§Ã£o (apenas em main)
  production-build:
    name: ğŸš€ Production Build
    runs-on: ubuntu-latest
    needs: [backend-quality, android-build, frontend-check, security-scan]
    if: github.ref == 'refs/heads/main'
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ğŸ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: ğŸ—ï¸ Build APK de produÃ§Ã£o
      run: |
        cd android_app
        flutter pub get
        flutter build apk --release

    - name: ğŸ“¦ Upload APK de produÃ§Ã£o
      uses: actions/upload-artifact@v3
      with:
        name: production-apk
        path: android_app/build/app/outputs/flutter-apk/app-release.apk

    - name: ğŸ³ Build Docker Backend
      run: |
        cd backend
        docker build -t moransa-backend:latest .

  # Job 6: RelatÃ³rio de Qualidade
  quality-report:
    name: ğŸ“Š Quality Report
    runs-on: ubuntu-latest
    needs: [backend-quality, android-build, frontend-check, security-scan]
    if: always()
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“Š Gerar relatÃ³rio de qualidade
      run: |
        echo "# ğŸ“Š RelatÃ³rio de Qualidade - Moransa CI/CD" > quality-report.md
        echo "" >> quality-report.md
        echo "## ğŸ¯ Status dos Jobs" >> quality-report.md
        echo "- Backend Quality: ${{ needs.backend-quality.result }}" >> quality-report.md
        echo "- Android Build: ${{ needs.android-build.result }}" >> quality-report.md
        echo "- Frontend Check: ${{ needs.frontend-check.result }}" >> quality-report.md
        echo "- Security Scan: ${{ needs.security-scan.result }}" >> quality-report.md
        echo "" >> quality-report.md
        echo "## ğŸ“ˆ MÃ©tricas" >> quality-report.md
        echo "- Commit: ${{ github.sha }}" >> quality-report.md
        echo "- Branch: ${{ github.ref_name }}" >> quality-report.md
        echo "- Autor: ${{ github.actor }}" >> quality-report.md
        echo "- Data: $(date)" >> quality-report.md
        
        cat quality-report.md

    - name: ğŸ“¤ Upload relatÃ³rio
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: quality-report.md
